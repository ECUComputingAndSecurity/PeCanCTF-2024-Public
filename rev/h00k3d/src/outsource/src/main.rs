use sha2::{Sha256, Digest};
use rand::seq::SliceRandom;
use rand::prelude::*;

// Null terminate the hints so that they look like C strings
// Also stops `strings` from continuing after them for neatness
// Adding strings of spaces also means our hints appear nice and
// separate to the rest of the revealed information
static HINTS: &str = "\x00      \x00      \x00Can't strings this one!\x00
But you can have a hint\x00
Have you ever heard of function hooking?\x00      \x00      \x00";

#[link(name = "simple_random")]
extern "C" {
    fn initialise(seed: u64);
    fn random_uint32() -> u32;
}

fn seed_generators(seed: u64) {
    unsafe {
        initialise(seed);
    }
}

fn get_next_u32() -> u32 {
    unsafe {
        random_uint32()
    }
}

fn main() {
    // Stops HINTS from being removed for dead code
    format!("{}", HINTS);

    println!("Welcome to the Pseudo Random Data Hashing Processor Program (PRDHPP)!");
    println!("This program uses `random_uint32` from libsimple_random.so to hash thousands of random numbers and put them into one convenient hash for you! Some random data will even be validated to make sure you'll get the correct hash!\n");

    // This is just for obscurity, the seed doesn't really matter
    let mut shuffler = StdRng::seed_from_u64(847529486734532);

    // Shuffle all the seeds for extra obscurity
    println!("Rearranging data ^-^...");
    // There are 512 of these
    // The sheer volume makes it impractical to do manually
    let mut seeds: Vec<u64> = vec![8976227319312884208, 5583857106714765938, 4710687012256354459, 15408029008866213846, 4153909546201708607, 17869110143462082365, 2506963940932683636, 6693727465263886439, 4434299455247947816, 16288587399698815242, 11263536822234071007, 8983719965423865067, 3089645313113072142, 17576785222881044248, 13872063678715415398, 11921737088034906543, 11726586692189622939, 13169764505900132228, 11324961510344580055, 14129285940121531273, 3901917848913444561, 11045551963698919046, 12495516438308508107, 8733655019070089921, 13058631874700061540, 3886827659239032158, 2688795210547710539, 132703960563506172, 13281313066126962345, 7686066553303189981, 15076956693165754601, 7107051629341297309, 12505863731652551174, 15245834813603700886, 4896103726269465932, 13398848812556907454, 2909122798987636479, 16893189467321242407, 8154398115984184937, 7222694345884554874, 2663969875383726745, 3033856816051732254, 12427325342895151427, 6711657905309621029, 4933781852216606708, 13040976905268025373, 2149857716859395609, 12140921166702897383, 15277648216666364351, 10630467473586775972, 16617379974009099280, 463715724787330502, 2200889630778268395, 7837763416583923094, 10405286144985208518, 16296341498628006957, 636860506813048549, 8237060027653651913, 3811561321501977383, 5239732236238318584, 11142972900547786961, 12564339239522889683, 5101412152030017115, 9212998035150659701, 2887654848544514513, 5301653412771196213, 2934980668272396087, 12521336248357773064, 5949215498883154762, 8074147146667149915, 8603580713374038879, 3960095031088619558, 12802447011907285499, 15883001219724062458, 11112032663123260485, 268077145390589608, 4081113952933422654, 14169635228360886350, 8529517390516976419, 18169422946306018245, 5609106353118080485, 14599237468995032808, 7704335735610976053, 4357632670559805756, 11484568653719943132, 7027903771014281773, 9576289688807123246, 6494216891018852483, 469301425965331428, 16536388163305812069, 491084224848009297, 6612250710644453667, 14815856944140080309, 17814904601055082297, 16489503469464517078, 18315511025093122636, 12929015261478606800, 9792561456601529371, 7371340915913073370, 6591906566834506193, 12449724430952286779, 3764022581021995964, 235591001773106255, 173540970623520913, 2057080852310472977, 1212973161327905569, 1255707533518226084, 5802651983340174722, 9716254621388823316, 3822634168333688508, 10972299253717767996, 4583197469514610208, 4058768095403132288, 17058295373088569271, 12450188974761411825, 15657656086409607243, 17722756546131110401, 18346716904217764367, 10073275858322231626, 15581592724134421837, 8364822369640077769, 16022532533131807803, 2410846892630322099, 14545949846681225276, 4397660986608041049, 15268055414555561055, 12772876970830743402, 235139704726871817, 5683135409075792591, 10183552508800275914, 427774656432249200, 12270540131184185150, 9528817519321127435, 7147749411569156210, 5195861776255153554, 1812345860115559557, 1465444572727097155, 6076695339524465965, 2266038438364006344, 11652504557791956759, 4977578329728922082, 425784661267133540, 4731680236799973720, 11493954754332146212, 2852078451981911635, 2004026364597420177, 555216447557527299, 12729516501035571567, 7625434528683704225, 17682740517683441395, 4059057614233204460, 15000850537740918573, 6027221746506073211, 14340313481990747450, 8174963217726410263, 9371493749507724987, 15928532629058558626, 13707416413064455138, 851886974804605947, 133402181443159057, 7860279704466166676, 8292390329451967326, 15606064987664621424, 14029931568545697010, 7462223413352360448, 17482598585268997041, 4188396877718319209, 6284065030886378945, 11837918410038775708, 2826054487346445165, 6489893561873205848, 4607586640878076763, 15579867863107726973, 16281305432804361081, 17506979331236507483, 2271667666847544844, 15617128713053766871, 11503936658626376343, 6856080391836850127, 1558693984054297109, 9378287850091994271, 10678146864165533044, 4193920829710288872, 18313587753661885190, 17943281826600611669, 11640349254202537128, 10794813500024082154, 16178541932086931563, 9194205057263260933, 17651633129140435609, 4560015536057604673, 3647335226850376094, 7032906697882367760, 209787792223762775, 6381680137753101069, 2292153198112609846, 6479259646886571090, 8722848556527657072, 4795505402072367530, 9047628477926858723, 16740046079856090797, 4649930866994511279, 18358241999101612612, 6133931405455409253, 14032449991825266589, 121351466028738233, 9000324289311245423, 6327942602669330186, 2373082101627033745, 756561318179858366, 11398427212297911218, 10695928428021998828, 8801001594282347623, 3017300777390045273, 23854640506588361, 14637432781106313355, 4607510718265829386, 3439522299437830898, 3983203718812254703, 4728221462676736808, 4553748266942895952, 12030668954888502219, 8610503755330286695, 6917377321026499534, 12391943889044775627, 6538103920428028319, 18214337519221466135, 11085108315263605621, 1669407827501088867, 5271349314520540819, 18163992919340881485, 3275870012428720384, 17544964746973628121, 4159753868462829871, 8940278011979740755, 3638752927804461094, 13252978339440981420, 17559504730340702956, 12342178471033129498, 4803608014768663033, 2642273367531926236, 578331366370489008, 144949290054297755, 12607085506491275400, 3322565003384282415, 1966335175867266302, 3901650519143896141, 15769425306688437356, 10109958205935710377, 4635617670126104058, 15134675546444740859, 11533785001870892439, 5688920610184212559, 5529438570742306761, 8398319859082564427, 7367123955051798483, 13057239679398951568, 12570299619962308441, 12759025630788533889, 8864957246352108215, 3146933994706351211, 16298215855540155267, 3058974435592454301, 12922278809034369322, 11473168948385338334, 6265852213968558819, 96759686481717271, 3311857721930290687, 1185115962481981930, 6850525054284530551, 8840218009958776570, 4074118570545696323, 6177725518999847680, 15382196639022124725, 11042686408527245700, 17708616365372160873, 8533626811178691121, 17027442896139400887, 1722129468617512682, 14557346246023388850, 17565433169799405149, 9108560681213097578, 9399541920952236430, 6254966608057780425, 759013856913594126, 3958932347807945134, 15196827217729787982, 1841939394846379702, 13877173862272481503, 8133008052462182214, 3547784909751061661, 7249621585835647733, 5768731392504349475, 12953885206342438419, 14330170196662717399, 5069003299647769088, 17957165365755372848, 12012418200330050767, 12680395611268105019, 17376376955625574252, 12388757959001988216, 10624949739634976798, 11711205537454119618, 1591636656492099870, 7948472120240777589, 8615367601068496435, 17401585448419933635, 11697918622381385788, 137095383544567016, 4497381900093287282, 194136379935706459, 248649383066176586, 898420670581702086, 8009150563914354169, 4090385868776138382, 8423385634408519035, 1758751206052525848, 17256485788124117451, 16440681082271666809, 15320157486729687233, 9453571260183477876, 16193053752572085549, 14636562266382283530, 7671151456001098486, 17431851507896104435, 16859534079663467105, 17530661822798043950, 12487642193585791876, 11334690840262228930, 17557928631141457453, 17227954764856371472, 7363987813307264775, 12966119189157743095, 55293826715638506, 16248759120056061841, 14372347469874500962, 11890171965754191618, 17059781951468649408, 6439590832475800916, 3436069443553937353, 17836300496725446893, 679681276022088583, 2718337227891736864, 9223742710355488462, 8854537159314484374, 16426584967977788389, 4280424434209183612, 8078879872502199488, 542004340311156259, 2196533624276024995, 1372574770220884348, 17525928354426266002, 6602974763292735910, 1511313253571366721, 4747566135571438309, 3067766713039896631, 15633119949915243269, 12053196291639970817, 3407626277491709988, 3790893224583606995, 8898189823552884236, 9250607629451899998, 14952868929741027367, 13464823092302286511, 14506383439644925330, 9523196279905448221, 5327299499777634750, 2247809942949302788, 10635966033875902265, 14775409492700691648, 14454561614739105867, 5469601605603922974, 8569288041248555104, 5791419323937812865, 6645812168857326953, 8560173039417835662, 1429131961378261098, 10188276872206598383, 12956623596949348843, 17123979368547189902, 13349949080002193312, 17892618766803641243, 18265813408912772527, 8583041200781139808, 15683661086609614395, 2394933316001469064, 11975851389263969811, 13784993731742705557, 11847170593647738468, 1163823661959117601, 15908910690487825829, 12079575037810241014, 14076183168697291075, 2029484124643393447, 7957814658176385807, 2851225947542180748, 18056942292233762174, 15456911268283213206, 4102350773134262416, 13639787450191114706, 16488604738486503576, 7359633735096081645, 12136516020089335559, 6601052952808532161, 2692040375192054068, 7848696042667386009, 13341015898647274953, 905495751178373601, 2839190098794828122, 6515358346434249383, 15261215003780658066, 14926210947488907200, 7533685986828829938, 3732244620679284516, 1178402585180346404, 7570094401983328338, 13449682913040382236, 8795755479246222579, 10408711289955846493, 7777533332382148740, 8774858664517129377, 12709027527468878408, 11993004616024218130, 5719711587319931925, 217202021069374609, 16112579305567075127, 14676412449991420381, 3082026112980351854, 11495437621439948928, 17508180826532116711, 9468110298601307852, 4844679369688313781, 3153259055701420260, 8708046567402446025, 2392272244040938405, 15866663180081611308, 5280432055622759871, 13618465969953385562, 5603311789231406525, 3874065613563130638, 5123935967197749336, 11229208186466018041, 15423720337591468348, 4856697068114797219, 8080875322587635352, 3914316541644677203, 7651807021918043457, 3306310747995534259, 3604596389655809312, 447266036166918009, 9842850560949052739, 12339208910258725008, 11499857388086524582, 11243675638848891338, 4792044718420940066, 4728728235464926474, 7231576166649380086, 5890432441058584634, 4689704713780746076, 9088442476600929886, 4476505088471915961, 10894617923643816631, 4396072942724695765, 7696814388039916044, 6986980663369982447, 15889687018960529712, 16725873489709857532, 14714440108969531766, 15467274981387166221, 16851407917782841501, 13381268209745959764, 123846739512563294, 14533718316377411984, 17590470840350611642, 2806925567694771691, 11626151084820017676, 15777158853197324795, 14106304834556030785, 13851889085246188232, 7654322779234072762, 8981081663440195769, 4821626473912504697, 6852563380364426493, 17074898131654489864, 3161459416195929802, 3238977293889623120, 4412496200053989248, 6701124430202226086, 17358208915826376452, 3633556274731317814, 13542810056749661385, 18116943139734827234, 8035855471996992391, 3176789229889286573, 1285081828367983690, 133259422863419506, 5951654546196672247, 8922795367083275415, 7427693204525698390, 901210378533003567, 9789168720212950569, 9466640405608393660, 1987833954535581452, 12099398016719397059, 8686356734644334758, 14135844645569620991, 13999750415971410079, 14218790046833022666, 4108453446321167565, 913579671038471968, 17772713054254104950, 5963199376111371682];
    seeds.shuffle(&mut shuffler);

    let mut hasher = Sha256::new();

    println!("Processing data ^-^...");
    for seed in seeds {
        seed_generators(seed);
        for i in 0..16 {
            let number = get_next_u32();
            if seed == 8976227319312884208 {
                if (i == 0 && number != 3354320501) || (i == 5 && number != 2282152761) || (i == 12 && number != 1456629187) || (i == 15 && number != 1850468975) {
                    println!("Received number '{}' should be '{}'.", number, match i {
                        0  => 3354320501_u32,
                        5  => 2282152761_u32,
                        12 => 1456629187_u32,
                        15 => 1850468975_u32,
                        _  => panic!("This should be unreachable")
                    });
                    if i == 15 {
                        println!("INVALID DATA DETECTED. EXITING. >:|.");
                        return;
                    }
                }
            }
            hasher.update(number.to_le_bytes());
        }
    }

    // Full successful hash: 4b96907a0edab766f6fc5208941f30937511727a09c2b7141dbf9610027f29a4
    let hash = hasher.finalize();

    let true_hash: Vec<u8> = vec![0x4b, 0x96, 0x90, 0x7a, 0x0e, 0xda, 0xb7, 0x66, 0xf6, 0xfc, 0x52, 0, 0, 0, 0, 0, 0, 0, 0, 0x7a, 0x09, 0xc2, 0xb7, 0x14, 0x1d, 0xbf, 0x96, 0x10, 0x02, 0x7f, 0x29, 0xa4];
    for i in 0..true_hash.len() {
        // Compare hashes ignoring the zeros
        if true_hash[i] != hash[i] && true_hash[i] != 0 {
            println!("INVALID DATA DETECTED. INTERFERENCE DETECTED. EXITING. >:|.");
            return;
        }
    }

    // Start building the hash section of the flag
    // 08941f3093751172
    let mut flag_part = String::new();
    for i in 11..19 {
        flag_part += &format!("{:02x}", hash[i]);
    }

    // Flag: pecan{b41t&5w1tch_08941f3093751172}
    println!("Data successfully processed! :D");
    println!("Result:");
    println!("pecan{{{}_{}}}", "b41t&5w1tch", flag_part);
}
